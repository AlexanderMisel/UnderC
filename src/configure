#!/bin/sh
#-----------------------------------------------------------------------
# underC configure script to generate makefile from makefile.in
# Charles F. Randall, cfr@pobox.com
#-----------------------------------------------------------------------
# Extract _UCV_ from version.h for use in makefile
# - find the line, print the third field, strip the double quotes
version_file=version.h
UC_VERSION=`awk '/^[ \t]*#define[ \t]+_UCV_[ \t]+/ { print $3}' $version_file \
    | sed 's/\"//g'`

if [ -z "$UC_VERSION" ]
then
    echo Unable to extract _UCV_ from $version_file
fi
echo Configuring underC version $UC_VERSION ...

# Set UC_HOME based on current directory
# - get pwd and chop off last directory (same as .. from here)
UC_HOME=`pwd | sed 's|/src$||'`

if [ -z "$UC_HOME" ]
then
    echo "Unable to determine UC_HOME (pwd or sed failed?)"
    exit 1
fi
echo Setting UC_HOME to $UC_HOME

# Looks like a BSD variant?
uname -s | grep BSD > /dev/null
if [ $? = 0 ]
then
    BSD="BSD=1"
fi

# generating config.h
config_h="config.h"
rm -f $config_h
echo "/* This file is automatically generated by configure. Do not edit */" \
    > $config_h || ("Could not create $config_h. Exiting" && exit 1)
echo "#define UC_HOME \"$UC_HOME\"" >> $config_h

# replace variables in makefile.in
echo Generating makefile from makefile.in
tmpfile=makefile.$$
sed "s|\@\@UC_VERSION\@\@|$UC_VERSION|g; \
    s|\@\@UC_HOME\@\@|$UC_HOME|g;
    s|\@\@BSD\@\@|$BSD|g;" \
    makefile.in > $tmpfile \
    && mv $tmpfile makefile && echo Done. Now run make. && exit
echo "Substitution failed. Exiting."
rm -f $tmpfile
exit 1
